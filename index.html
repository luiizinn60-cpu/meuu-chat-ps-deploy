<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omegle - Interativo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos Globais e Reset (Mais modernos) */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f9fc; /* Fundo muito claro e moderno */
            color: #2c3e50; /* Texto escuro */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: 20px;
        }
        
        /* Container Principal (Layout centralizado) */
        #main-container {
            width: 100%;
            max-width: 1000px; /* Mais largura */
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Título */
        h1 {
            color: #3498db; /* Azul moderno */
            font-size: 2.5em;
            font-weight: 700;
            margin: 10px 0 25px 0;
            text-align: center;
        }
        
        /* Indicador de Status */
        #status-indicator {
            padding: 8px 15px;
            margin-bottom: 20px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            transition: background-color 0.5s ease;
        }

        /* Estrutura de Duas Colunas */
        #content-wrapper {
            display: flex;
            width: 100%;
            gap: 25px;
            flex-wrap: wrap;
        }

        /* Área de Vídeo/Controles */
        #video-controls-area {
            flex: 1;
            min-width: 300px; 
            display: flex;
            flex-direction: column;
        }

        /* Caixas de Vídeo (Com Borda Suave e Destaque) */
        .video-box {
            width: 100%;
            background-color: #ecf0f1; /* Cinza claro */
            border: 2px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* Sombra suave */
            overflow: hidden;
            position: relative;
            min-height: 250px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }
        .video-box video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
            background-color: #000;
        }
        .video-box:hover {
             border-color: #3498db; /* Destaque ao passar o mouse */
        }
        
        /* Botão "Next" (Estilo Botão de Ação) */
        #nextButton {
            background-color: #e74c3c; /* Vermelho Ação */
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 0 #c0392b; /* Sombra 3D */
            transition: all 0.15s ease;
            width: 100%;
            box-sizing: border-box;
        }
        #nextButton:active {
            box-shadow: 0 1px 0 #c0392b;
            transform: translateY(2px);
        }

        /* Área de Chat */
        #chat-area {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        /* Lista de Mensagens */
        #messages {
            list-style-type: none;
            margin: 0;
            padding: 15px;
            height: 250px; 
            overflow-y: auto; 
            flex-grow: 1;
        }
        #messages > li {
            padding: 6px 0;
            line-height: 1.4;
            transition: opacity 0.3s;
        }

        /* Input de Chat */
        #form {
            padding: 10px 15px;
            display: flex;
            border-top: 1px solid #eee;
            background-color: #f7f9fc;
        }
        #input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }
        #input:focus { border-color: #3498db; }
        
        #form button {
            background-color: #3499db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #form button:hover { background-color: #2980b9; }

        /* Responsividade para telas menores */
        @media (max-width: 650px) {
            #content-wrapper {
                flex-direction: column;
                gap: 15px;
            }
            #video-controls-area, #chat-area { min-width: 100%; }
            .video-box { max-width: 100%; }
            #nextButton { width: 100%; }
            #messages { max-height: 150px; }
        }
    </style>
</head>
<body>
    <div id="main-container">
        <h1>Omegle</h1>
        <div id="status-indicator">Buscando Parceiro...</div>

        <div id="content-wrapper">
            
            <div id="video-controls-area">
                <div class="video-box"><video id="localVideo" autoplay muted playsinline></video></div>
                <div class="video-box"><video id="remoteVideo" autoplay playsinline></video></div>
                
                <button id="nextButton">Next</button>
            </div>

            <div id="chat-area">
                <ul id="messages"></ul>
                
                <form id="form" action="">
                    <input id="input" autocomplete="off" placeholder="Digite sua mensagem..." />
                    <button>Enviar</button>
                </form>
            </div>
            
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- VARIÁVEIS GLOBAIS ---
        var socket = io();
        var localStream;
        var peerConnection; 
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const messages = document.getElementById('messages');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const nextButton = document.getElementById('nextButton');
        const statusIndicator = document.getElementById('status-indicator'); // NOVO ELEMENTO
        
        const iceServers = {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' }, 
            ]
        };

        // --- FUNÇÃO DE STATUS INTERATIVA ---
        function updateStatus(message, color) {
            statusIndicator.textContent = message;
            statusIndicator.style.backgroundColor = color;
        }
        
        // --- 1. CHAT DE TEXTO ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat message', input.value); 
                input.value = '';
            }
        });

        socket.on('chat message', function(msg) {
            var item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        // --- 2. WEBRTC (Conexão) ---
        async function startWebRTC() {
            try {
                updateStatus("Buscando Parceiro...", "#f39c12"); // Amarelo/Laranja: Buscando

                if (!localStream) { 
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    localVideo.srcObject = localStream;
                }

                if (peerConnection) {
                    peerConnection.close();
                }
                peerConnection = new RTCPeerConnection(iceServers);

                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                peerConnection.ontrack = (event) => {
                    if (event.streams && event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                        updateStatus("Conectado!", "#27ae60"); // Verde: Conectado
                    }
                };

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate && socket.otherUserId) {
                        socket.emit('candidate', socket.otherUserId, event.candidate);
                    }
                };
                
                messages.innerHTML = '';
                remoteVideo.srcObject = null;
                socket.otherUserId = null; 
                
                socket.emit('ready-for-new-partner'); 

            } catch (error) {
                updateStatus("Erro na Câmera/Microfone. Recarregue.", "#e74c3c"); // Vermelho: Erro
                alert('É necessário permitir o acesso à webcam e microfone e recarregar a página.');
                console.error('WebRTC Startup Error:', error);
            }
        }

        // --- 3. SINALIZAÇÃO E EVENTOS ---
        async function createOffer() {
            if (!peerConnection || !socket.otherUserId) return;
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('offer', socket.otherUserId, peerConnection.localDescription);
        }
        
        socket.on('user-connected', (userId) => {
            socket.otherUserId = userId; 
            createOffer(); 
            // O status será atualizado no evento peerConnection.ontrack (quando o vídeo chega)
        });

        socket.on('offer', async (id, description) => {
            socket.otherUserId = id;
            peerConnection.setRemoteDescription(description);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', id, peerConnection.localDescription);
        });

        socket.on('answer', (id, description) => {
            peerConnection.setRemoteDescription(description);
        });

        socket.on('candidate', (id, candidate) => {
            if (peerConnection) { 
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        });

        socket.on('user-disconnected', (userId) => {
            if (userId === socket.otherUserId) {
                updateStatus("Parceiro Desconectado. Buscando Novo...", "#3498db"); // Azul: Desconectado/Buscando
                remoteVideo.srcObject = null;
                socket.otherUserId = null;
                socket.emit('find-new-partner'); 
            }
        });

        // --- 4. LÓGICA DO BOTÃO NEXT ---
        nextButton.addEventListener('click', () => {
            updateStatus("Buscando Parceiro...", "#f39c12"); // Amarelo/Laranja: Buscando

            if (socket.otherUserId) {
                 socket.emit('find-new-partner'); 
            }
            
            if (peerConnection) {
                peerConnection.close();
            }
            
            startWebRTC(); 
        });

        // INICIA O PROCESSO WEBRTC QUANDO A PÁGINA CARREGA
        startWebRTC();
    </script>
</body>
</html>

