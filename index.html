<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omegle</title>
    <style>
        /* Estilos CSS do Omegle */
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding-bottom: 3rem; 
            background-color: #f6f6f6; /* Fundo muito claro */
            color: #333;
        }
        
        /* Container Principal do Vídeo */
        #video-container { 
            display: flex; 
            justify-content: center; 
            gap: 20px; /* Espaçamento entre os vídeos */
            padding: 20px 0;
            margin: 20px auto;
            max-width: 900px;
        }

        /* Estilo da Caixa de Vídeo */
        .video-box {
            width: 48%;
            max-width: 450px;
            border: 1px solid #ddd; 
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background-color: #fff;
            position: relative;
            min-height: 300px; /* Altura mínima para visualização */
            overflow: hidden;
        }
        .video-box video { 
            width: 100%; 
            height: auto; 
            display: block; 
            object-fit: cover;
            border-radius: 4px; 
        }

        /* Estilo da Caixa de Chat (Mensagens) */
        #messages { 
            list-style-type: none; 
            margin: 0 auto; 
            padding: 10px 20px; 
            max-width: 900px;
            min-height: 100px; /* Altura da caixa de chat */
            max-height: 200px;
            overflow-y: auto; /* Permite rolar */
            border: 1px solid #ddd;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 70px; /* Espaço para o input fixo */
        }
        #messages > li { 
            padding: 8px 0; 
            border-bottom: 1px dotted #eee; 
            font-size: 0.95em;
        }
        #messages > li:last-child {
            border-bottom: none;
        }

        /* Formulário (Caixa de Texto Fixa) */
        #form { 
            background: #fff; 
            padding: 10px 20px; 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            display: flex; 
            height: 50px;
            box-sizing: border-box; 
            border-top: 1px solid #ccc;
            justify-content: center;
        }
        #form-inner {
             display: flex;
             width: 100%;
             max-width: 900px;
        }
        #input { 
            border: 1px solid #ccc; 
            padding: 0 1rem; 
            flex-grow: 1; 
            border-radius: 4px; 
            margin-right: 10px;
            font-size: 1em;
        }
        #input:focus { outline: none; border-color: #007bff; }
        #form button { 
            background: #007bff; 
            border: none; 
            padding: 0 20px; 
            border-radius: 4px; 
            outline: none; 
            color: #fff; 
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <div class="video-box"><video id="localVideo" autoplay muted playsinline></video></div>
        <div class="video-box"><video id="remoteVideo" autoplay playsinline></video></div>
    </div>

    <ul id="messages"></ul>
    
    <form id="form" action="">
        <div id="form-inner">
            <input id="input" autocomplete="off" placeholder="Digite sua mensagem aqui..." /><button>Enviar</button>
        </div>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- VARIÁVEIS GLOBAIS ---
        var socket = io();
        var localStream;
        var peerConnection; 
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const iceServers = {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' }, 
            ]
        };

        // --- 1. CHAT DE TEXTO ---
        var form = document.getElementById('form');
        var input = document.getElementById('input');
        var messages = document.getElementById('messages');
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat message', input.value);
                input.value = '';
            }
        });

        socket.on('chat message', function(msg) {
            var item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight; // Rola para a última mensagem
        });

        // --- 2. WEBRTC (Conexão) ---
        async function startWebRTC() {
            try {
                // 2.1 Capturar a mídia local (webcam e mic)
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;

                // 2.2 Iniciar a conexão P2P (RTCPeerConnection)
                peerConnection = new RTCPeerConnection(iceServers);

                // 2.3 Adicionar a mídia local à conexão
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // 2.4 Lidar com o fluxo de vídeo remoto
                peerConnection.ontrack = (event) => {
                    if (event.streams && event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                    }
                };

                // 2.5 Lidar com os CANDIDATOS ICE
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('candidate', socket.otherUserId, event.candidate);
                    }
                };

                // 2.6 Tentar criar a OFERTA (Se for o primeiro a entrar)
                createOffer(); 

            } catch (error) {
                alert('É necessário permitir o acesso à webcam e microfone e recarregar a página.');
            }
        }

        // --- 3. FUNÇÕES DE OFERTA/RESPOSTA ---
        async function createOffer() {
            if (!peerConnection || !socket.otherUserId) return;
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('offer', socket.otherUserId, peerConnection.localDescription);
        }

        // --- 4. RECEBIMENTO DE SINALIZAÇÃO DO SERVIDOR ---
        
        socket.on('user-connected', (userId) => {
            socket.otherUserId = userId; 
            createOffer(); 
        });

        socket.on('offer', async (id, description) => {
            socket.otherUserId = id;
            peerConnection.setRemoteDescription(description);
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', id, peerConnection.localDescription);
        });

        socket.on('answer', (id, description) => {
            peerConnection.setRemoteDescription(description);
        });

        socket.on('candidate', (id, candidate) => {
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        });

        socket.on('user-disconnected', (userId) => {
            if (userId === socket.otherUserId) {
                alert("O outro usuário se desconectou. Recarregue a página para encontrar um novo.");
            }
        });

        // INICIA O PROCESSO WEBRTC
        startWebRTC();
    </script>
</body>
</html>
